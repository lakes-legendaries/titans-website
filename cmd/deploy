#!/bin/bash

# compile files
cmd/compile

# get access
if [ -z "$AZURE_STORAGE_CONNECTION_STRING" ]; then

    # load key from file
    for FILE in .azconn ~/.azconn; do
        if [ -f $FILE ]; then
            export AZURE_STORAGE_CONNECTION_STRING="$(cat $FILE)"
            break
        fi
    done

    # error checking
    if [ -z "$AZURE_STORAGE_CONNECTION_STRING" ]; then
        echo "Cannot connect to Azure. "
        echo "Set AZURE_STORAGE_CONNECTION_STRING, "
        echo "or provide it in an .azconn file."
        exit 1
    fi
fi

# upload files in directories
for DIR in script style; do
    az storage blob upload-batch \
        -s "$DIR" \
        -d "\$web" \
        --destination-path "$DIR" \
        --no-progress \
    1> /dev/null
done

# upload root html files
az storage blob upload-batch \
    -s "$(pwd)" \
    -d "\$web" \
    --pattern "$(pwd)/*.html" \
    --no-progress \
1> /dev/null
